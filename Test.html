 <!DOCTYPE HTML>
<html lang="en">
<head>

    <!--<button type="button" onclick="">Click Me!</button>-->
</head>
<body>
<div id="canvasesdiv" style="position:relative; width:800px; height:450px">
    <canvas id="layer1"
            style="z-index: 1;
position:absolute;
left:0px;
top:0px;
" height="450px" width="800">
        This text is displayed if your browser does not support HTML5 Canvas.
    </canvas>
    <canvas id="layer2"
            style="z-index: 2;
position:absolute;
left:0px;
top:0px;
" height="450px" width="800">
        This text is displayed if your browser does not support HTML5 Canvas.
    </canvas>
    <canvas id="layer3"
            style="z-index: 3;
position:absolute;
left:0px;
top:0px;
" height="450px" width="800">
        This text is displayed if your browser does not support HTML5 Canvas.
    </canvas>
</div>

<!--<canvas width="800" height="450"></canvas>-->
<!--<script src="http://documentcloud.github.com/backbone/backbone.js"></script>-->
<script src="Scripts/Library/Underscore/Underscore.js"></script>
<script src="Scripts/Library/log4javascript/log4javascript_uncompressed.js"></script>
<script src="Scripts/Library/Sylvester/Sylvester.src.js"></script>
<script src="Scripts/Common/Class.js"></script>
<script src="Scripts/Common/CachedTimedValue.js"></script>
<script src="Scripts/Common/TimedValue.js"></script>
<script src="Scripts/Common/LinearTimedValue.js"></script>
<script src="Scripts/Common/Sylvester.src.js"></script>
<script src="Scripts/Common/DynamicProperty.js"></script>
<script src="Scripts/Common/Event.js"></script>
<script src="Scripts/Common/GuidGenerator.js"></script>
<script src="Scripts/Common/HashSet.js"></script>
<script src="Scripts/Common/HashTable.js"></script>
<script src="Scripts/Common/PolyFill.js"></script>
<script src="Scripts/Common/Timer.js"></script>
<script src="Scripts/Common/TransformationMatrixHelper.js"></script>

<script src="Scripts/SceneNode/SceneNode.js"></script>
<script src="Scripts/SceneNode/SceneNodePointAdapter.js"></script>
<script src="Scripts/SceneNode/SceneNodeManager.js"></script>
<script src="Scripts/Shape/Path.js"></script>
<script src="Scripts/Shape/Point.js"></script>
<script src="Scripts/Shape/Joint.js"></script>
<script src="Scripts/Shape/EndPoint.js"></script>
<script src="Scripts/Shape/SegmentRenderer.js"></script>
<script src="Scripts/Shape/ShapeRenderer.js"></script>
<script src="Scripts/Shape/Segment.js"></script>
<script src="Scripts/Shape/Shape.js"></script>
<script src="Scripts/Shape/ArcSegmentRenderer.js"></script>
<script src="Scripts/Shape/ArcJoint.js"></script>
<script src="Scripts/Shape/ArcSegment.js"></script>
<script src="Scripts/Shape/ArrowSegmentRenderer.js"></script>
<script src="Scripts/Shape/ArrowEndPoint.js"></script>
<script src="Scripts/Shape/Line.js"></script>
<script src="Scripts/Shape/LineSegmentRenderer.js"></script>
<script src="Scripts/Shape/LineSegment.js"></script>
<script src="Scripts/Shape/BezierSegmentRenderer.js"></script>
<script src="Scripts/Shape/BezierSegment.js"></script>
<script src="Scripts/Shape/PolyLineShape.js"></script>
<script src="Scripts/Shape/ArrowShape.js"></script>
<script src="Scripts/Shape/RectangleShape.js"></script>
<script src="Scripts/Shape/RoundedRectangleShape.js"></script>
<script src="Scripts/Shape/TextShape.js"></script>

<script src="Scripts/Transformation/LinearTransition.js"></script>
<script src="Scripts/Transformation/FollowPathTransition.js"></script>
<script src="Scripts/Transformation/FollowDirectionTransition.js"></script>
<script src="Scripts/Transformation/PointLinearTransition.js"></script>
<script src="Scripts/Transformation/ColorLinearTransition.js"></script>
<script src="Scripts/Transformation/TransformationMatrixLinearTransition.js"></script>
<script src="Scripts/Transformation/LinearTransformation.js"></script>
<script src="Scripts/Transformation/PathTransformation.js"></script>
<script src="Scripts/Transformation/ToggleTransformation.js"></script>
<script src="Scripts/Transformation/PointTransformation.js"></script>

<script src="Scripts/SceneManager.js"></script>
<script src="Scripts/Scene.js"></script>
<script src="KeyFrame.js"></script>
<script src="Scripts/TimeLineControl.js"></script>
<script src="Scripts/TimeLineController.js"></script>
<script src="Scripts/Track.js"></script>
<script src="Scripts/Transition.js"></script>
<script type="text/javascript">
var context = document.getElementsByTagName('canvas')[1].getContext('2d');
var contextBackground = document.getElementsByTagName('canvas')[0].getContext('2d');
var canvasBackground = document.getElementsByTagName('canvas')[0];
var canvas = document.getElementsByTagName('canvas')[1];

//    try
//    {
//        var path = {
//            RatioStart:0.5,
//            RatioEnd:1,
//            IsClosedPath:false,
//            Elements: [{ X:100, Y:0, JointType:"endPoint" },
//                       { SegmentType:"bezier", ControlPoint1:{X:200, Y:0}, ControlPoint2:{X:200, Y:100} },
//                       { X:100, Y:100, JointType:"endPoint" }]
//        };


//        var path2 = [
//            { X:100, Y:0, JointType:"endPoint" },
//            { SegmentType:"line", ControlPoint1:{X:200, Y:0}, ControlPoint2:{X:200, Y:100} },
//            { X:100, Y:100, JointType:"endPoint" }
//        ];
//
//        var points = [new Point(100, 0), new Point(100, 100)];
//        var point1 = new Point(200, 0);
//        var point2 = new Point(200, 100);


//        var path2 = {
//            IsClosedPath: false,
//            Origin: {X: 100, Y: 0},
//            Items: [
//            { X:100, Y:0, JointType:"endPoint" },
//            { SegmentType:"bezier" },
//            { JointType:"corner", X:100, Y:100 },
//            { SegmentType:"line" },
//            { X:200, Y:100, JointType:"endPoint" }
//        ]
//    };

var path2 = {
    IsClosedPath:false,
    Origin:{X:100, Y:100},
    Items:[
//        { X:0, Y:0 },
//        { SegmentType:"bezier", ControlPoint1:{ X:0, Y:-100 }, ControlPoint2:{ X:100, Y:-100 } },
//        { X:100, Y:0 },
//        { SegmentType:"bezier", ControlPoint1:{ X:100, Y:100 }, ControlPoint2:{ X:200, Y:100 } },
        { X:0, Y:0 },
        { SegmentType:"line"},
        { X:100, Y:0 },
        { SegmentType:"line"},
        { X:100, Y:100 }
    ]
};

var polyLine = new PolySegmentShape(0, path2);
//polyLine.StrokeDashPattern = [0.1, 0.1];
polyLine.StrokeDashOffset.set(0, 0);
polyLine.StrokeDashOffset.set(10000, 1000);

polyLine.StrokeRatio.End.set(0,0);
polyLine.StrokeRatio.End.set(10000, 1);
polyLine.StrokeColor.set(0, {R:120, G:120, B:120});
polyLine.render(0, context);

var arrow = new ArrowShape(0);
arrow.SceneNode.setPosition(0, new Point(100, 100));
arrow.SceneNode.followPath(10000, polyLine.Path, 0, 1);
//arrow.SceneNode.translate(15000, 100, 100);


var arrow2 = new ArrowShape(0);
arrow2.SceneNode.setPosition(0, new Point(100, 300));
arrow2.SceneNode.followPathOrientation(10000, polyLine.Path, 0, 1);
arrow2.render(0, context);


//arrow.SceneNode.setPath(polyLine.Path, 10000);


//        t0 = 0;
//        t1 = 0.5;
//
//
//        function getSegment(p1, p2, p3, p4, t0, t1) {
//
//            var u0 = 1-t0;
//            var u1 = 1-t1;
//
//            var pp1 = p1.x(u0*u0*u0).add(p2.x(3*t0*u0*u0)).add(p3.x(3*t0*t0*u0)).add(p4.x(t0*t0*t0));
//            var pp2 = p1.x(u0*u0*u1).add(p2.x(2*t0*u0*u1 + u0*u0*t1)).add(p3.x(t0*t0*u1 + 2*u0*t0*t1)).add(p4.x(t0*t0*t1));
//            var pp3 = p1.x(u0*u1*u1).add(p2.x(t0*u1*u1 + 2*u0*t1*u1)).add(p3.x(2*t0*t1*u1 + u0*t1*t1)).add(p4.x(t0*t1*t1));
//            var pp4 = p1.x(u1*u1*u1).add(p2.x(3*t1*u1*u1)).add(p3.x(3*t1*t1*u1)).add(p4.x(t1*t1*t1));
//
//            return [pp1, pp2, pp3, pp4];
//        }

//        function getSegment(p1, p2, p3, p4, t0, t1) {
//
//            var u0 = 1-t0;
//            var u1 = 1-t1;
//
//            var p1X = u0*u0*u0*p1.X + (t0*u0*u0 + u0*t0*u0 + u0*u0*t0)*p2.X + (t0*t0*u0 + u0*t0*t0 + t0*u0*t0)*p3.X + t0*t0*t0*p4.X;
//            var p1Y = u0*u0*u0*p1.Y + (t0*u0*u0 + u0*t0*u0 + u0*u0*t0)*p2.Y + (t0*t0*u0 + u0*t0*t0 + t0*u0*t0)*p3.Y + t0*t0*t0*p4.Y;
//            var p2X = u0*u0*u1*p1.X + (t0*u0*u1 + u0*t0*u1 + u0*u0*t1)*p2.X + (t0*t0*u1 + u0*t0*t1 + t0*u0*t1)*p3.X + t0*t0*t1*p4.X;
//            var p2Y = u0*u0*u1*p1.Y + (t0*u0*u1 + u0*t0*u1 + u0*u0*t1)*p2.Y + (t0*t0*u1 + u0*t0*t1 + t0*u0*t1)*p3.Y + t0*t0*t1*p4.Y;
//            var p3X = u0*u1*u1*p1.X + (t0*u1*u1 + u0*t1*u1 + u0*u1*t1)*p2.X + (t0*t1*u1 + u0*t1*t1 + t0*u1*t1)*p3.X + t0*t1*t1*p4.X;
//            var p3Y = u0*u1*u1*p1.Y + (t0*u1*u1 + u0*t1*u1 + u0*u1*t1)*p2.Y + (t0*t1*u1 + u0*t1*t1 + t0*u1*t1)*p3.Y + t0*t1*t1*p4.Y;
//            var p4X = u1*u1*u1*p1.X + (t1*u1*u1 + u1*t1*u1 + u1*u1*t1)*p2.X + (t1*t1*u1 + u1*t1*t1 + t1*u1*t1)*p3.X + t1*t1*t1*p4.X;
//            var p4Y = u1*u1*u1*p1.Y + (t1*u1*u1 + u1*t1*u1 + u1*u1*t1)*p2.Y + (t1*t1*u1 + u1*t1*t1 + t1*u1*t1)*p3.Y + t1*t1*t1*p4.Y
//
//            return [new Point(p1X, p1Y), new Point(p2X, p2Y), new Point(p3X, p3Y), new Point(p4X, p4Y)];
//        }


// var newPoints = getSegment(points[0], point1, point2, points[1], t0, t1);

//        xa = points[0].X;
//        ya = points[0].Y;
//        xb = point2.X;
//        yb= point2.Y;
//        xc = point1.X;
//        yc= point1.Y;
//        xd = points[1].X;
//        yd = points[1].Y;


//        var path =
//                        [{ X:newPoints[0].X, Y:newPoints[0].Y, JointType:"endPoint" },
//                            { SegmentType:"bezier", ControlPoint1:{X:newPoints[1].X, Y:newPoints[1].Y}, ControlPoint2:{X:newPoints[2].X, Y:newPoints[2].Y} },
//                            { X:newPoints[3].X, Y:newPoints[3].Y, JointType:"endPoint" }]
//                ;


//var points1 = [new Point(200, 100), new Point(300, 200)];


//        var points = [new Point(200, 200), new Point(200, 100)];
//var poly2 = new PolyLineShape(path, 0);


//        var bezier = new PolyLineShape(0, points, false, false);
//
//
//
//        //bezier.for(200).follows(path);
//
//
//
//
//        var point1 = new TimedValue(function(){ return new PointLinearTransition(); });
//        var point2 = new TimedValue(function(){ return new PointLinearTransition(); });
//        point1.set(new Point(100, 200), 0);
//        point2.set(new Point(100, 100), 0);
//
//        bezier.Path.Segments[0].setControlPoints(point1, point2);
//
//poly2.SceneNode.setPosition(new Point(200, 100), 0);
//poly2.SceneNode.setPath(polyLine.Path, 5000);

//poly2.render(context, 0);

//var pointx = bezier.Path.Segments[0].pointFromRatio(0, 0.5);

//        t0 = 0;
//        t1 = 0.5;
//
//        u0 = 1.0 - t0
//        u1 = 1.0 - t1
//
//        x1 = points[0].X;
//        y1 = points[0].Y
//        x2 = points[1].X;
//        y2 = points[1].Y
//        bx1 = point1.get(0).X;
//        by1 = point1.get(0).Y;
//        bx2 = point2.get(0).X;
//        by2 = point2.get(0).Y;
//
//        xa =  x1*u0*u0 + bx1*2*t0*u0 + bx2*t0*t0
//        xb =  x1*u1*u1 + bx1*2*t1*u1 + bx2*t1*t1
//        xc = bx1*u0*u0 + bx2*2*t0*u0 +  x2*t0*t0
//        xd = bx1*u1*u1 + bx2*2*t1*u1 +  x2*t1*t1
//
//        ya =  y1*u0*u0 + by1*2*t0*u0 + by2*t0*t0
//        yb =  y1*u1*u1 + by1*2*t1*u1 + by2*t1*t1
//        yc = by1*u0*u0 + by2*2*t0*u0 +  y2*t0*t0
//        yd = by1*u1*u1 + by2*2*t1*u1 +  y2*t1*t1

//        t = 0.5;
//
//        x1 = points[0].X;
//        y1 = points[0].Y
//        x2 = point1.get(0).X;
//        y2 = point1.get(0).Y
//        x3 = point2.get(0).X;
//        y3 = point2.get(0).Y
//
//
//        x4 = points[1].X;
//        y4 = points[1].Y
//
//        x12 = (x2-x1)*t+x1
//        y12 = (y2-y1)*t+y1
//
//        x23 = (x3-x2)*t+x2
//        y23 = (y3-y2)*t+y2
//
//        x34 = (x4-x3)*t+x3
//        y34 = (y4-y3)*t+y3
//
//        x123 = (x23-x12)*t+x12
//        y123 = (y23-y12)*t+y12
//
//        x234 = (x34-x23)*t+x23
//        y234 = (y34-y23)*t+y23
//
//        x1234 = (x234-x123)*t+x123
//        y1234 = (y234-y123)*t+y123
//
//
//
//
//        points2 = [new Point(x1, y1), new Point(x1234, y1234)];
//        var bezier2 = new PolyLineShape(0, points2, false, false);
//
//        point1 = new TimedValue(function(){ return new PointLinearTransition(); });
//        point2 = new TimedValue(function(){ return new PointLinearTransition(); });
//        point1.set(new Point(x12, y12), 0);
//        point2.set(new Point(x123, y123), 0);
//
//
//
//        bezier2.Path.Segments[0].setControlPoints(point1, point2);
//
//
//
//        bezier2.SceneNode.setPosition(bezier.Path.getPointFromRatio(0, 0.5), 0);
//
//
//
//        // var length =bezier.Path.Segments[0].length();
//
//
//
//
//    bezier2.render(context, 0);
//    }
//    catch(ex)
//    {
//        alert(ex);
//    }

/*
 var rectangle = new RectangleShape(0, 150, 25, 150, 100);
 rectangle.render(context, 0);

 var roundedRectangle = new RoundedRectangleShape(0, 150, 150, 100, 100, 10);
 roundedRectangle.render(context, 0);
 */
var points = [new Point(0, 100), new Point(100, 100), new Point(100, 300), new Point(300, 300)];//, new Point(100, 200)];//, new Point(10, 300), new Point(30, 330), new Point(100, 200)];

//var points = [new Point(0, 100), new Point(100, 100), new Point(200, 100)];

/* var polyLine = new PolyLineShape(0, points, false, false);

 //polyLine.Points[0].set(new Point(0, 200), 10000, new PointLinearTransition());
 polyLine.Points[2].set(new Point(200, 200), 10000, new PointLinearTransition());


 polyLine.SceneNode.setPosition(new Point(200, 100), 0);

 polyLine.SceneNode.rotate(Math.PI*-2, 10000);

 polyLine.SceneNode.setPosition(new Point(400, 100), 5000);


 //polyLine.SceneNode.rotate(Math.PI/4, 5000);

 polyLine.StrokeColor.set({R:255,G:255,B:0}, 5000);
 polyLine.StrokeColor.set({R:0,G:0,B:255}, 10000);
 //polyLine.StrokeOpacity.set(0, 10000);
 //log4javascript.getDefaultLogger().info(polyLine.toString());

 polyLine.render(context, 15);
 */
//    var text = new TextShape("127.0.0.1", 0, 50);
//    text.render(context);

var m_drawGrid = true;
function onClickDisplayGrid() {
    m_drawGrid = !m_drawGrid;
    drawGrid();
}


function drawGrid() {
    contextBackground.clearRect(0, 0, 800, 450);

    contextBackground.fillStyle = "#FAF7F8";
    contextBackground.beginPath();
    contextBackground.rect(0, 0, 800, 450);
    contextBackground.closePath();
    contextBackground.fill();

    if (m_drawGrid) {
        for (var i = 0; i < canvas.height; i += 50) {

            contextBackground.save();
            contextBackground.strokeStyle = "gray";
            contextBackground.lineWidth = 1;
            contextBackground.moveTo(0.5, i + 0.5);
            contextBackground.lineTo(canvas.width + 0.5, i + 0.5);
            contextBackground.stroke();
            contextBackground.restore();
        }

        for (var i = 0; i < canvas.width; i += 50) {
            contextBackground.save();
            contextBackground.strokeStyle = "gray";
            contextBackground.lineWidth = 1;
            contextBackground.moveTo(i + 0.5, 0.5);
            contextBackground.lineTo(i + 0.5, canvas.height + 0.5);
            contextBackground.stroke();
            contextBackground.restore();

        }
    }

}

function onBeforeRendered(from, t, context) {
    //Clear Canvas
    context.clearRect(0, 0, canvas.width, canvas.height);

    //(timestamp / 10000)


}
var sceneManager = new SceneManager(0, 20000, context);

var timeLineControl = new TimeLineControl(sceneManager.TimeLineController);

sceneManager.TimeLineController.BeforeRenderEvent.subscribe(onBeforeRendered, this);
sceneManager.addToScene(polyLine);
sceneManager.addToScene(arrow);
sceneManager.addToScene(arrow2);
drawGrid();

//
//    var track = new Track();
//    track.FirstKeyFrame.addElements([rectangle, polyLine]);
//
//    var newKeyFrame = track.addNewKeyFrame(6000);
//    polyLine = newKeyFrame.getElement(polyLine.Id);
//    var rectangle2 = newKeyFrame.getElement(rectangle.Id);
//
//    polyLine.setPoints([new Point(0, 100), new Point(100, 100), new Point(100, 300), new Point(400, 400)]);
//
//    log4javascript.getDefaultLogger().info(polyLine.toString());
//
//    rectangle2.setSize(300, 300, 300, 50);
//
//    newKeyFrame = track.addNewKeyFrame(15000);
//
//    timeLine.RootSceneGroup.addToScene("test", track);
//    track.generateTransitions();
//
function onClickPlay() {
    if (sceneManager.TimeLineController.IsStarted) {
        sceneManager.TimeLineController.stop();
    }
    else {
        sceneManager.TimeLineController.start(sceneManager.TimeLineController.CurrentTime);
    }
}


</script>

<button type="button" onclick="onClickPlay()">Play</button>
<button type="button" onclick="onClickDisplayGrid()">Display/Hide grid</button>
</body>
</html>
